<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Reasoning‑Trace Comparison Study</title>
    <style>
        body {
            font-family: sans-serif;
            max-width: 900px;
            margin: 40px auto;
        }

        img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 8px 0;
        }

        #completion,
        #submitting,
        #task {
            display: none;
        }

        #instructions-panel {
            display: none;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 20px;
            background: #f9f9f9;
        }

        #intro {
            border: 1px solid #ccc;
            padding: 20px;
            background: #f0f0f0;
            margin-bottom: 20px;
        }

        /* two‑column layout for the options */
        .options {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .option-card {
            flex: 1 1 400px;
            border: 1px solid #ddd;
            padding: 10px;
        }

        pre {
            white-space: pre-wrap;
            background: #f7f7f7;
            padding: 8px;
            border-radius: 4px;
        }

        button,
        input {
            cursor: pointer;
            font-size: 1em;
        }

        #startButton[disabled],
        #nextButton[disabled] {
            opacity: .5;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <h1>Which Reasoning Trace Is Easier to Understand?</h1>

    <!-- 1) Intro screen -->
    <div id="intro">
        <h2>Welcome!</h2>
        <p>Please enter your Participant ID to begin:</p>
        <input type="text" id="participantIdInput" placeholder="e.g. abc123">
        <p>In this study you will be shown a <strong>question</strong> about an image and two candidate
            <em>reasoning traces</em> produced by different AI models (labelled “Option A” and “Option B”).<br>
            Each candidate includes:
        </p>
        <ul>
            <li>the image the model with visual indicators if the model references parts of the image,</li>
            <li>its step‑by‑step thought process,</li>
            <li>the final answer it produced.</li>
        </ul>
        <p>Your job is simple: <strong>pick the option whose thought process is easier for you to follow and
                understand.</strong></p>

        <h3>Example</h3>
        <p><em>(Illustrative only – not an actual task)</em></p>
        <div class="options">
            <div class="option-card">
                <h4>Option A</h4>
                <img src="data/examples/example_img1.png" alt="Example image 1">
                <pre>I first locate the car near the centre…
The pedestrian is to the right…
Therefore the car is…</pre>
                <p><strong>Final answer:</strong> Car</p>
            </div>
            <div class="option-card">
                <h4>Option B</h4>
                <img src="data/examples/example_img2.png" alt="Example image 2">
                <pre>Look at the person…
Distance to building appears smaller…
Hence pedestrian…</pre>
                <p><strong>Final answer:</strong> Pedestrian</p>
            </div>
        </div>
        <p>Which option’s reasoning is clearer? That’s all you’ll indicate on each trial.</p>

        <button id="startButton" disabled>Start Study</button>
    </div>

    <!-- 2) Main task -->
    <div id="task">
        <button id="toggleInstructions">Show Instructions</button>
        <div id="instructions-panel">
            <h3>Detailed Instructions</h3>
            <p>For every trial:</p>
            <ol>
                <li>Read the <strong>question</strong> at the top.</li>
                <li>Review the two options (image + thought process + final answer).</li>
                <li>Select the option whose reasoning you find <u>easier to understand and follow</u>.</li>
            </ol>
            <p>If both seem equally clear, choose the one that feels slightly better. There is no “Unsure” option.</p>
        </div>

        <p id="progress"></p>
        <p id="question"></p>

        <form id="responseForm">
            <fieldset id="responseOptions" disabled>
                <div class="options">
                    <div class="option-card" id="cardA">
                        <h4>Option A</h4>
                        <img id="imgA" src="" alt="Option A image">
                        <pre id="reasoningA"></pre>
                        <p><strong>Final answer:</strong> <span id="answerA"></span></p>
                        <label><input type="radio" name="choice" value="A" required> Choose Option A</label>
                    </div>
                    <div class="option-card" id="cardB">
                        <h4>Option B</h4>
                        <img id="imgB" src="" alt="Option B image">
                        <pre id="reasoningB"></pre>
                        <p><strong>Final answer:</strong> <span id="answerB"></span></p>
                        <label><input type="radio" name="choice" value="B"> Choose Option B</label>
                    </div>
                </div>
                <div style="margin-top:15px;">
                    <button type="submit" id="nextButton" disabled>Next</button>
                </div>
            </fieldset>
        </form>
    </div>

    <!-- 3) Submitting screen -->
    <div id="submitting">
        <h2>All done!</h2>
        <p>Saving your responses… please wait for your completion code.</p>
    </div>

    <!-- 4) Completion screen -->
    <div id="completion">
        <h2>Thank you!</h2>
        <p>Your completion code is: <strong>CR510SPY</strong></p>
    </div>

    <script>
        (async function () {
            const STUDY = 'reasoning_comparison';
            const DATA_PATH = `data/${STUDY}/data.jsonl`;
            const SUBMIT_URL = 'https://script.google.com/macros/s/AKfycby93WIxDfo4fx1Mvl2UO84MUO9qI3JMKWp6MAIW3wY35BA5aXCPSjiHUdmLR_CxK1N-5A/exec`;

            /* ------------ participant ID gate ------------ */
            let participantId = '';
            const idInput = document.getElementById('participantIdInput');
            const startBtn = document.getElementById('startButton');
            idInput.addEventListener('input', () => startBtn.disabled = idInput.value.trim() === '');

            /* ------------ preload trials ------------ */
            const raw = await fetch(DATA_PATH).then(r => r.text());
            const trials = raw.trim().split('\n').map(l => JSON.parse(l));

            /* ------------ element references ------------ */
            const introDiv = document.getElementById('intro');
            const taskDiv = document.getElementById('task');
            const submitDiv = document.getElementById('submitting');
            const compDiv = document.getElementById('completion');

            const toggleBtn = document.getElementById('toggleInstructions');
            const instrDiv = document.getElementById('instructions-panel');

            const progressEl = document.getElementById('progress');
            const questionEl = document.getElementById('question');

            /* option elements */
            const imgA = document.getElementById('imgA');
            const imgB = document.getElementById('imgB');
            const reasoningA = document.getElementById('reasoningA');
            const reasoningB = document.getElementById('reasoningB');
            const answerA = document.getElementById('answerA');
            const answerB = document.getElementById('answerB');

            const form = document.getElementById('responseForm');
            const fieldset = document.getElementById('responseOptions');
            const nextBtn = document.getElementById('nextButton');

            /* ------------ helpers ------------ */
            function shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            /* ------------ start study ------------ */
            startBtn.onclick = () => {
                participantId = idInput.value.trim();
                introDiv.style.display = 'none';
                taskDiv.style.display = 'block';
                showTrial();
            };

            /* toggle instructions */
            toggleBtn.onclick = () => {
                const show = instrDiv.style.display !== 'block';
                instrDiv.style.display = show ? 'block' : 'none';
                toggleBtn.textContent = show ? 'Hide Instructions' : 'Show Instructions';
            };

            let idx = 0;
            const responses = [];

            function showTrial() {
                const t = trials[idx];
                progressEl.textContent = `Trial ${idx + 1} of ${trials.length}`;
                questionEl.textContent = `Question: ${t.Question}`;

                /* construct choices array and randomise */
                const choices = shuffle([
                    { label: 'A', img: t.img_path1, reasoning: t.reasoning1, answer: t.Answer1, model: 1 },
                    { label: 'B', img: t.img_path2, reasoning: t.reasoning2, answer: t.Answer2, model: 2 }
                ]);

                /* populate DOM */
                const first = choices.find(c => c.label === 'A');
                const second = choices.find(c => c.label === 'B');

                imgA.src = first.img;
                reasoningA.textContent = first.reasoning;
                answerA.textContent = first.answer;

                imgB.src = second.img;
                reasoningB.textContent = second.reasoning;
                answerB.textContent = second.answer;

                /* enable after both images load */
                fieldset.disabled = true;
                nextBtn.disabled = true;
                Promise.all([imgA.decode(), imgB.decode()]).then(() => {
                    fieldset.disabled = false;
                    nextBtn.disabled = false;
                });

                form.reset();
                /* store mapping so we know which model corresponds to A/B this trial */
                form.dataset.mapping = JSON.stringify({
                    A: first.model,
                    B: second.model
                });
            }

            form.addEventListener('submit', async e => {
                e.preventDefault();
                const mapping = JSON.parse(form.dataset.mapping);
                const chosenLabel = form.choice.value;      // 'A' or 'B'
                const chosenModel = mapping[chosenLabel];   // 1 or 2

                responses.push({
                    id: trials[idx].id,
                    index: trials[idx].index,
                    chosen: chosenModel,
                    label: chosenLabel,
                    orderShown: mapping        // record full A/B mapping for transparency
                });

                idx++;
                if (idx < trials.length) {
                    showTrial();
                } else {
                    /* submitting */
                    taskDiv.style.display = 'none';
                    submitDiv.style.display = 'block';

                    const payload = {
                        participantId,
                        timestamp: new Date().toISOString(),
                        responses
                    };
                    await fetch(SUBMIT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    submitDiv.style.display = 'none';
                    compDiv.style.display = 'block';
                }
            });
        })();
    </script>
</body>

</html>